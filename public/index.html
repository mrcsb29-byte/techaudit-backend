<script>
document.getElementById("auditBtn").addEventListener("click", async () => {
  const secret = document.getElementById("secret").value.trim();
  const url = document.getElementById("url").value.trim();
  const strategy = document.getElementById("strategy").value;

  const errorBadge = document.getElementById("errorBadge");
  const perfEl = document.getElementById("perfScore");
  const webVitalEl = document.getElementById("webVitals");
  const seoEl = document.getElementById("seoScore");
  const rawEl = document.getElementById("rawDebug");

  errorBadge.style.display = "none";
  perfEl.textContent = "...";
  webVitalEl.textContent = "...";
  seoEl.textContent = "...";
  rawEl.textContent = "...";

  try {
    const response = await fetch(
      `/audit?url=${encodeURIComponent(url)}&strategy=${strategy}`,
      {
        headers: { "x-techaudit-secret": secret }
      }
    );

    if (!response.ok) {
      errorBadge.style.display = "inline-block";
      rawEl.textContent = "Erreur HTTP : " + response.status;
      return;
    }

    const data = await response.json();

    // ðŸŽ¯ RÃ©sumÃ© performance
    perfEl.textContent = data.performance
      ? (data.performance * 100).toFixed(0) + "%"
      : "N/A";

    // ðŸŽ¯ Core Web Vitals
    webVitalEl.innerHTML = `
      <strong>FCP :</strong> ${data.coreWebVitals.firstContentfulPaint}<br>
      <strong>LCP :</strong> ${data.coreWebVitals.largestContentfulPaint}<br>
      <strong>TBT :</strong> ${data.coreWebVitals.totalBlockingTime}<br>
      <strong>CLS :</strong> ${data.coreWebVitals.cumulativeLayoutShift}
    `;

    // ðŸŽ¯ SEO
    seoEl.textContent = data.seo
      ? (data.seo * 100).toFixed(0) + "%"
      : "N/A";

    rawEl.textContent = JSON.stringify(data, null, 2);

  } catch (err) {
    console.error("Erreur JS:", err);
    errorBadge.style.display = "inline-block";
    rawEl.textContent = String(err);
  }
});
</script>
