<script>
  async function lancerAudit() {
    const secret = document.getElementById("secret").value.trim();
    const url = document.getElementById("url").value.trim();
    const strategy = document.getElementById("strategy").value.trim();

    const badge = document.getElementById("statusBadge");
    const rawOutput = document.getElementById("rawOutput");
    const perfScore = document.getElementById("perfScore");
    const coreVitalsOutput = document.getElementById("coreVitalsOutput");
    const seoOutput = document.getElementById("seoOutput");

    // Reset UI
    badge.textContent = "Chargement‚Ä¶";
    badge.style.background = "#444";
    rawOutput.textContent = "";
    perfScore.textContent = "";
    coreVitalsOutput.textContent = "";
    seoOutput.textContent = "";

    try {
      // -----------------------------
      // üî• APPEL UNIQUE : /pagespeed-audit
      // -----------------------------
      const endpoint = `/pagespeed-audit?url=${encodeURIComponent(url)}&strategy=${encodeURIComponent(strategy)}`;

      const resp = await fetch(endpoint, {
        headers: {
          "x-techaudit-secret": secret
        }
      });

      const data = await resp.json();
      rawOutput.textContent = JSON.stringify(data, null, 2);

      if (!resp.ok) {
        badge.textContent = "Erreur ‚ùå";
        badge.style.background = "#b30000";
        return;
      }

      // -----------------------------
      // üî• AFFICHAGE DES DONN√âES
      // -----------------------------
      badge.textContent = "Succ√®s ‚úî";
      badge.style.background = "#00b67b";

      // R√©sum√© performance
      perfScore.textContent = (data.performanceScore * 100).toFixed(0) + "/100";

      // Core Web Vitals
      coreVitalsOutput.innerHTML = `
        <div>FCP : ${data.coreWebVitals.firstContentfulPaint}</div>
        <div>LCP : ${data.coreWebVitals.largestContentfulPaint}</div>
        <div>TBT : ${data.coreWebVitals.totalBlockingTime}</div>
        <div>CLS : ${data.coreWebVitals.cumulativeLayoutShift}</div>
      `;

      // SEO (si ajout√© plus tard)
      if (data.seo) {
        seoOutput.textContent = data.seo.score;
      }

    } catch (err) {
      badge.textContent = "Erreur ‚ùå";
      badge.style.background = "#b30000";
      rawOutput.textContent = err.toString();
    }
  }
</script>
